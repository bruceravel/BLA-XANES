#!/usr/bin/perl -I/home/bruce/git/BLA-XANES/lib  -I/home/bruce/git/XAS-Data-Interchange/perl/lib

use strict;
use warnings;
use Xray::BLA;
use Config::IniFiles;
use Getopt::Long;

my $energy     = 0;
my $verbose    = 1;
my $save       = 0;
my $animate    = 0;
my $configfile = q{};
my $xdiini     = q{};      # '/home/bruce/git/BLA-XANES/share/bla.xdi.ini'
my $result  = GetOptions ("energy|e=i"  => \$energy,
			  'save|s'      => \$save,
			  'animate|a'   => \$animate,
			  'verbose|v'   => \$verbose,
			  'config|c=s'  => \$configfile,
			  'xdiini|x=s'  => \$xdiini,
			  'quiet|q'     => sub { $verbose = 0 },
			  'help|h'      => \&usage,
			 );

&usage if not $ARGV[0];
&usage if not $configfile;
&usage if not $energy;

tie my %ini, 'Config::IniFiles', ( -file => $configfile );

my $spectrum = Xray::BLA->new;
$spectrum->scanfolder	($ini{measure}{scanfolder});
$spectrum->tiffolder	($ini{measure}{tiffolder});
$spectrum->outfolder	($ini{measure}{outfolder});
$spectrum->stub		($ARGV[0]);
$spectrum->peak_energy	($energy);

$spectrum -> bad_pixel_value   ($ini{pixel}{bad})    if exists $ini{pixel}{bad};
$spectrum -> weak_pixel_value  ($ini{pixel}{weak})   if exists $ini{pixel}{weak};
$spectrum -> lonely_pixel_value($ini{pixel}{lonely}) if exists $ini{pixel}{lonely};
$spectrum -> social_pixel_value($ini{pixel}{social}) if exists $ini{pixel}{social};
$spectrum -> mask(save=>$save, verbose=>$verbose, animate=>$animate);
$spectrum -> scan(verbose=>$verbose, xdiini=>$xdiini);

sub usage {
  print "
  herfd [options] <stub>

     --config  | -c         [string]  configuration file (required)
     --energy  | -e         [integer] emission energy (required)
     --animate | -a         [flag]    save tiff animation of mask creation
     --save    | -s         [flag]    save intermediate steps of mask creation
     --verbose | -v         [flag]    write progress messages
     --quiet   | -q         [flag]    suppress progress messages
     --help    | -h         [flag]    write this message and exit

  This script assumes that scan files and image files have related names.

  example:  herfd -c /path/to/config.ini -e 9713 -a Aufoil1

  In this example, the scan file is called `Aufoil1.001' and the image
  files are called `Aufoil1_NNNNN.tif'.  File locations are specified
  in the configuration file.

";
  exit;
};
